<div class="h-full flex flex-col p-4 md:p-4 min-h-0">
    <div class="flex flex-col flex-1 bg-white rounded-xl shadow border border-gray-200 overflow-hidden h-full">

        <div class="px-6 py-3 border-b border-gray-100 flex items-center justify-between bg-white shrink-0">
            <h3 appText="h2">
                Crear nueva denuncia
            </h3>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6" #scrollArea>

            <form [formGroup]="form" (ngSubmit)="guardarDenuncia()" class="max-w-4xl mx-auto space-y-6 ">

                <div>
                    <label for="titulo" class="block text-sm font-bold text-slate-700 mb-2">
                        Título de la denuncia
                    </label>
                    <app-input id="titulo" formControlName="titulo" type="text"
                        placeholder="Ej: Semáforo dañado en la Av. Amazonas" [maxlength]="100"
                        [class.border-red-300]="form.get('titulo')?.invalid && form.get('titulo')?.touched">
                    </app-input>

                    <div class="mt-1.5 text-xs flex items-center justify-between">
                        <div id="titulo-help" class="text-slate-500">Requerido. 5–100 caracteres.</div>
                        <div class="font-mono text-slate-400">{{ (form.get('titulo')?.value?.length || 0) }}/100</div>
                    </div>
                </div>

                <div>
                    <label for="descripcion" class="block text-sm font-bold text-slate-700 mb-2">Descripción
                        detallada</label>
                    <app-input id="descripcion" formControlName="descripcion" [multiline]="true" [rows]="6"
                        placeholder="Describe detalladamente lo que está ocurriendo, incluyendo referencias visuales..."
                        [maxlength]="1000">
                    </app-input>

                    <div class="mt-1.5 text-xs flex items-center justify-between">
                        <div id="descripcion-help" class="text-slate-500">Requerido. 10–1000 caracteres.</div>
                        <div class="font-mono text-slate-400">{{ (form.get('descripcion')?.value?.length || 0) }}/1000
                        </div>
                    </div>
                </div>

                <div>
                    <span class="block text-sm font-bold text-slate-700 mb-2">Categoría</span>
                    <app-category-selector [categories]="listadoCategorias" formControlName="categoriaDenuncia">
                    </app-category-selector>
                </div>

                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200/60">
                    <label for="anonimato" class="block text-sm font-bold text-slate-700 mb-2">
                        Nivel de Privacidad
                    </label>
                    <app-select id="nivelAnonimato" label="Nivel de Anonimato" [options]="listadoAnonimato()"
                        formControlName="nivelAnonimato" placeholder="Seleccione cómo desea enviar este reporte">
                    </app-select>

                    @if (form.get('nivelAnonimato')?.invalid && form.get('nivelAnonimato')?.touched) {
                    <div
                        class="mt-2 text-xs text-red-600 font-medium flex items-center gap-1 animate-in slide-in-from-top-1">
                        <fa-icon [icon]="faInfoCircle"></fa-icon>
                        <span>Debes seleccionar un nivel de privacidad.</span>
                    </div>
                    }
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="flex items-center text-sm font-bold text-slate-700 gap-2">
                            <fa-icon [icon]="faMapMarkerAlt" class="text-blue-600"></fa-icon>
                            Ubicación del incidente
                        </span>
                        <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">
                            Haz clic en el mapa para fijar el punto
                        </span>
                    </div>

                    <div class="relative w-full h-[260px] rounded-xl overflow-hidden border border-gray-300 shadow ring-1 ring-gray-50/50"
                        #mapContainer>
                    </div>
                </div>

                <div>
                    @defer (on viewport) {
                    <app-file-upload (filesChange)="evidencias.set($event)" [uploadFn]="uploadEvidenceStrategy"
                        (uploadError)="handleUploadError($event)">
                    </app-file-upload>
                    } @placeholder {
                    <div
                        class="h-24 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center bg-gray-50">
                        <span class="text-gray-400 text-xs">Cargando módulo de archivos...</span>
                    </div>
                    }
                </div>

                <div
                    class="pt-2 flex items-center justify-end gap-2 sticky bottom-0 bg-white/95 backdrop-blur-sm p-3 -mx-3 -mb-3 md:-mx-0 md:mb-0 md:bg-transparent md:static">
                    <app-submit-button [variant]="'medium'" [appearance]="'secondary'" [btnType]="'button'"
                        label="Cancelar" [icon]="faTimes" class="w-full md:w-auto">
                    </app-submit-button>

                    <app-submit-button [variant]="'medium'" [isLoading]="isLoading()" [btnType]="'submit'"
                        [isDisabled]="form.invalid" label="Enviar denuncia" [icon]="faPaperPlane"
                        class="w-full md:w-auto">
                    </app-submit-button>
                </div>
            </form>
        </div>
    </div>
</div>
