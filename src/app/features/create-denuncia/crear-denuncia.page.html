<div class="flex flex-col h-[calc(100%-3rem)] bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden m-6">
    <div class="px-8 py-6 border-b rounded-xl border-gray-100 flex items-center justify-between bg-white shrink-0">

        <h2 class="text-xl font-bold text-slate-800 tracking-tight">
            Crear nueva denuncia
        </h2>
    </div>

    <div class="flex-1 overflow-y-auto p-6" #scrollArea>

        @if (localError()) {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <strong class="font-bold">¡Atención! </strong>
            <span class="block sm:inline">{{ localError() }}</span>
        </div>
        }

        <form [formGroup]="form" (ngSubmit)="guardarDenuncia()" class="max-w-3xl mx-auto space-y-6">

            <div>
                <label for="titulo" class="block text-sm font-semibold text-slate-700 mb-2">
                    Título</label>
                <input id="titulo" formControlName="titulo" type="text" aria-describedby="titulo-help titulo-error"
                    maxlength="100"
                    class="block w-full rounded-lg bg-gray-50 border-gray-200 focus:border-blue-500 focus:ring-blue-500 py-3 px-4 transition-colors"
                    [class.border-red-300]="form.get('titulo')?.invalid && form.get('titulo')?.touched"
                    [class.focus:ring-red-200]="form.get('titulo')?.invalid && form.get('titulo')?.touched"
                    placeholder="Ej: Semáforo dañado en la Av. Amazonas" />

                <div class="mt-1 text-xs text-gray-500 flex items-center justify-between">
                    <div id="titulo-help">Requerido. 5–100 caracteres.</div>
                    <div class="text-gray-400">{{ (form.get('titulo')?.value?.length || 0) }}/100</div>
                </div>

                @if (form.get('titulo')?.invalid && form.get('titulo')?.touched) {
                <div id="titulo-error" class="mt-1 text-xs text-red-500">
                    @if (form.get('titulo')?.errors?.['required']) {
                    <div>El título es requerido.</div>
                    }
                    @if (form.get('titulo')?.errors?.['minlength']) {
                    <div>El título debe tener al menos 5 caracteres.</div>
                    }
                    @if (form.get('titulo')?.errors?.['maxlength']) {
                    <div>El título excede el máximo de 100 caracteres.</div>
                    }
                </div>
                }
            </div>

            <div>
                <label for="descripcion" class="block text-sm font-semibold text-slate-700 mb-2">Descripción</label>
                <textarea id="descripcion" formControlName="descripcion" rows="6"
                    aria-describedby="descripcion-help descripcion-error" maxlength="1000"
                    class="block w-full rounded-lg bg-gray-50 border-gray-200 focus:border-blue-500 focus:ring-blue-500 py-3 px-4 resize-none transition-colors"
                    placeholder="Describe detalladamente lo que está ocurriendo..."></textarea>

                <div class="mt-1 text-xs text-gray-500 flex items-center justify-between">
                    <div id="descripcion-help">Requerido. 10–1000 caracteres.</div>
                    <div class="text-gray-400">{{ (form.get('descripcion')?.value?.length || 0) }}/1000
                    </div>
                </div>

                @if (form.get('descripcion')?.invalid && form.get('descripcion')?.touched) {
                <div id="descripcion-error" class="mt-1 text-xs text-red-500">
                    @if (form.get('descripcion')?.errors?.['required']) {
                    <div>La descripción es requerida.</div>
                    }
                    @if (form.get('descripcion')?.errors?.['minlength']) {
                    <div>La descripción debe tener al menos 10 caracteres.</div>
                    }
                    @if (form.get('descripcion')?.errors?.['maxlength']) {
                    <div>La descripción excede el máximo de 1000 caracteres.</div>
                    }
                </div>
                }
            </div>

            <app-category-selector formControlName="categoria"> </app-category-selector>

            <div>
                <label class="flex items-center text-sm font-semibold text-slate-700 mb-2 gap-2">
                    <fa-icon [icon]="faMapMarkerAlt" class="text-blue-600"></fa-icon>
                    Ubicación del incidente
                </label>

                <div class="map-container relative w-full h-[350px] rounded-lg overflow-hidden border border-gray-200 shadow-inner"
                    #mapContainer></div>

                <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                    <fa-icon [icon]="faInfoCircle"></fa-icon> Haz clic en el mapa para fijar el marcador.
                </p>
            </div>


            <app-file-upload (filesChange)="evidencias.set($event)"
                (uploadError)="handleUploadError($event)"></app-file-upload>

            <div class="pt-4 border-t border-gray-100 flex items-center justify-end gap-3">
                <app-submit-button [variant]="'medium'" [appearance]="'secondary'" [btnType]="'button'"
                    label="Cancelar">
                </app-submit-button>
                <app-submit-button [variant]="'medium'" [isLoading]="isLoading()" [btnType]="'submit'"
                    [isDisabled]="form.invalid" label="Enviar denuncia" [icon]="faPaperPlane">
                </app-submit-button>
            </div>

        </form>
    </div>
</div>
